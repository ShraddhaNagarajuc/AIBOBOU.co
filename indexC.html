<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AIBOBOU CIRCULARS </title>

<style>
    body {
        font-family: Arial, sans-serif;
        padding: 25px;
        background: #fafafa;
    }
    h2 {
        margin-bottom: 15px;
    }
    .controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }
    input {
        padding: 8px;
        font-size: 15px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    th, td {
        padding: 12px;
        border: 1px solid #d9d9d9;
        text-align: left;
    }
    th {
        background: #e9f1ff;
    }
    tr:hover {
        background: #f4f8ff;
    }
    a {
        color: #0057ff;
        text-decoration: none;
        font-weight: 600;
    }
    a:hover {
        text-decoration: underline;
    }

    /* CATEGORY DROPDOWN */
    .category-box {
        position: relative;
        width: 150px;
    }
    .category-display {
        padding: 8px;
        background: white;
        border: 1px solid #aaa;
        cursor: pointer;
    }
    .category-dropdown {
        display: none;
        position: absolute;
        top: 38px;
        left: 0;
        width: 250px;
        background: white;
        border: 1px solid #aaa;
        max-height: 200px;
        overflow-y: auto;
        z-index: 9999;
        padding: 10px;
    }
    .category-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 5px 0;
    }

    /* TOOLTIP */
    .tooltip {
        position: relative;
    }
    .tooltip:hover::after {
        content: "Click to view";
        position: absolute;
        top: -28px;
        left: 5px;
        background: #333;
        color: white;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
    }
</style>
</head>

<body>

<h2>AIBOBOU CIRCULARS</h2>

<div class="controls">

    <input type="text" id="searchBox" placeholder="Search description…">

    <!-- CATEGORY MULTI FILTER -->
    <div class="category-box">
        <div class="category-display">Category ▾</div>
        <div class="category-dropdown" id="categoryDropdown">
            <label class="category-item"><input type="checkbox" value="Transfer Related"> Transfer Related</label>
            <label class="category-item"><input type="checkbox" value="Promotions Related"> Promotions Related</label>
            <label class="category-item"><input type="checkbox" value="Operational Issues"> Operational Issues</label>
            <label class="category-item"><input type="checkbox" value="Staff Welfare Measures"> Staff Welfare Measures</label>
            <label class="category-item"><input type="checkbox" value="Staffing Related"> Staffing Related</label>
            <label class="category-item"><input type="checkbox" value="HR Related issues"> HR Related issues</label>
            <label class="category-item"><input type="checkbox" value="Staff Accountability and disciplinary Policy"> Staff Accountability and disciplinary Policy</label>
            <label class="category-item"><input type="checkbox" value="Miscelleneous"> Miscelleneous</label>
        </div>
    </div>

    <!-- DATE RANGE -->
    <input type="text" id="fromDate" placeholder="From (dd-mm-yyyy)">
    <input type="text" id="toDate" placeholder="To (dd-mm-yyyy)">

    <button onclick="clearFilters()">Clear Filters</button>
</div>

<table>
    <thead>
        <tr>
            <th>Sr.No</th>
            <th>Date</th>
            <th>Description</th>
            <th>Category</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>

const endpoint = "https://script.google.com/macros/s/AKfycbwlHJE4IVzQCZIedoMpw0yJxnKgK90iFYAU4mXkyo_P036ic_1Flu-1JK8nCFbliL-jnQ/exec";

let globalData = [];

/* ------------------------ SMART DATE PARSER --------------------------- */
/* Accepts: dd-mm-yyyy, d-m-yy, yyyy, dd/mm/yyyy, mm/dd/yyyy */

function parseSmartDate(input) {
    if (!input || input.trim() === "") return null;

    input = input.replace(/\//g, "-"); // convert / to -

    // Year only (2023)
    if (/^\d{4}$/.test(input)) {
        return new Date(parseInt(input), 0, 1).getTime();
    }

    let parts = input.split("-");
    if (parts.length === 3) {
        let d = parseInt(parts[0]);
        let m = parseInt(parts[1]) - 1;
        let y = parseInt(parts[2].length === 2 ? "20"+parts[2] : parts[2]);
        return new Date(y, m, d).getTime();
    }

    return null;
}

/* ------------------------ LOAD DATA --------------------------- */
async function load() {
    const res = await fetch(endpoint);
    const data = await res.json();

    globalData = data;

    render();
}

/* ------------------------ FILTER & RENDER --------------------------- */
function render() {

    const searchText = document.getElementById("searchBox").value.toLowerCase();

    let selectedCats = [...document.querySelectorAll("#categoryDropdown input:checked")]
                        .map(c => c.value);

    let fromTs = parseSmartDate(document.getElementById("fromDate").value);
    let toTs = parseSmartDate(document.getElementById("toDate").value);

    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    globalData
        .filter(row => {

            // search filter
            if (!row.description.toLowerCase().includes(searchText)) return false;

            // category filter (multi)
            if (selectedCats.length > 0 && !selectedCats.includes(row.category)) return false;

            // date parsing
            let rowTs = parseSmartDate(row.date);

            // From Date
            if (fromTs && rowTs < fromTs) return false;

            // To Date
            if (toTs && rowTs > toTs) return false;

            return true;
        })
        .sort((a,b)=> parseSmartDate(b.date) - parseSmartDate(a.date))  // NEW SORT FIX
        .forEach(row => {

            const tr = document.createElement("tr");

            const hasLink = row.link && row.link.trim() !== "";

            tr.innerHTML = `
                <td>${row.srno}</td>
                <td>${row.date}</td>
                <td class="tooltip">
                    ${hasLink ? `<a href="${row.link}" target="_blank">${row.description}</a>` 
                              : row.description}
                </td>
                <td>${row.category}</td>
            `;

            tbody.appendChild(tr);
        });
}

/* ------------------------ CLEAR FILTERS --------------------------- */
function clearFilters() {
    document.getElementById("searchBox").value = "";
    document.getElementById("fromDate").value = "";
    document.getElementById("toDate").value = "";
    document.querySelectorAll("#categoryDropdown input").forEach(c => c.checked = false);
    render();
}

/* ------------------------ CATEGORY DROPDOWN --------------------------- */
document.querySelector(".category-display").addEventListener("click", () => {
    const dd = document.getElementById("categoryDropdown");
    dd.style.display = dd.style.display === "block" ? "none" : "block";
});

document.addEventListener("click", (e)=>{
    if (!e.target.closest(".category-box")) {
        document.getElementById("categoryDropdown").style.display = "none";
        render();
    }
});

load();

</script>

</body>
</html>
